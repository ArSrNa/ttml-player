import React, { CSSProperties, PropsWithChildren } from 'react';
import { AppleMusicLyric, LyricWord, parseTTMLToAppleMusicLyric } from './utils';
import { useLyricPlayer } from './useLyricPlayer';
import { SpringEffect } from './spring';
import './index.scss';

interface LyricPlayerProps {
    ttmlStr: string; // 原始 TTML 字符串
    isPlaying: boolean;
    currentTime: number;
    onTimeChange: (time: number) => void; // 通知播放器跳转时间
}

const LyricPlayer: React.FC<LyricPlayerProps> = ({
    ttmlStr,
    isPlaying,
    currentTime,
    onTimeChange
}) => {
    // 解析 TTML 歌词（只解析一次）
    const [lyric, setLyric] = React.useState<AppleMusicLyric | null>(null);
    React.useEffect(() => {
        try {
            const parsedLyric = parseTTMLToAppleMusicLyric(ttmlStr);
            setLyric(parsedLyric);
        } catch (e) {
            console.error('解析TTML失败:', e);
            setLyric(null);
        }
    }, [ttmlStr]);

    // 使用自定义Hook管理状态
    const {
        lyricContainerRef,
        currentLineRef,
        currentLine,
        currentWord,
        progressInWord,
        jumpToLine
    } = useLyricPlayer({
        lyric,
        isPlaying,
        currentTime
    });

    if (!lyric) return <div className="lyric-loading">加载歌词中...</div>;

    const currentIndex = lyric.allLines.findIndex(l => l.lineId === currentLine?.lineId);
    const [activeIndex, setActiveIndex] = React.useState(() => Math.max(0, currentIndex));
    React.useEffect(() => {
        if (currentIndex >= 0) {
            setActiveIndex(currentIndex);
        }
    }, [currentIndex]);

    const items = lyric.allLines.map((line) => {
        const isCurrent = currentLine?.lineId === line.lineId;
        return (
            <div
                key={`line_${line.lineId}`}
                className={`lyric-line ${isCurrent ? 'lyric-line--active' : ''}`}
                onClick={() => jumpToLine(line, onTimeChange)}
                ref={isCurrent ? currentLineRef : undefined}
            >
                <div className="lyric-words-main">
                    {line.words.filter(w => !w.isBackground).map((word) => {
                        const isCurrentWord = isCurrent && currentWord?.begin === word.begin;
                        const sungInCurrent = isCurrent && (word.begin < (currentWord?.begin ?? -Infinity) || word.end <= currentTime);
                        const sungInPastLine = !isCurrent && line.end <= currentTime;
                        const isSung = sungInCurrent || sungInPastLine;
                        const progress = isCurrentWord ? progressInWord * 100 : 0;
                        return (
                            <Word
                                key={`${line.lineId}-${word.begin}-${word.end}`}
                                currentTime={currentTime}
                                word={word}
                                isSung={isSung}
                                progress={progress}
                                isCurrentWord={!!isCurrentWord}
                            >
                                {word.text}
                            </Word>
                        );
                    })}
                </div>
                {isCurrent && line.words.some(w => w.isBackground) && (
                    <div className="lyric-words-background">
                        {line.words.filter(w => w.isBackground).map((word) => {
                            const isCurrentWord = currentWord?.begin === word.begin;
                            const isBeforeCurrent = currentWord && word.begin < currentWord.begin;
                            const isSung = isBeforeCurrent || (isCurrentWord && progressInWord > 0);
                            const progress = isCurrentWord ? progressInWord * 100 : 0;
                            return (
                                <span
                                    key={`${line.lineId}-bg-${word.begin}-${word.end}`}
                                    className={`lyric-word lyric-word--background ${isCurrentWord ? 'lyric-word--active' : ''} ${isSung ? 'lyric-word--sung' : ''}`}
                                    style={{
                                        '--progress': `${progress}%`
                                    } as CSSProperties}
                                >
                                    {word.text}
                                </span>
                            );
                        })}
                    </div>
                )}
            </div>
        );
    });

    return (
        <div>
            <SpringEffect items={items} current={activeIndex} />
        </div>
    );
};


function Word({ children, progress, isCurrentWord, isSung, word, currentTime }: PropsWithChildren<{
    progress: number;
    isCurrentWord: boolean;
    className?: string;
    isSung: boolean;
    word: LyricWord;
    currentTime: number;
}>) {
    return <span className='relative inline-block'>
        <div className='absolute left-0 top-0 z-1 text-red-500 lyric-word'
            style={{
                '--progress': !isSung ? isCurrentWord ? `${progress}%` : '0%' : '100%'
            } as CSSProperties}
        >{children}</div>
        <span className='relative left-0 top-0 z-0 text-gray-500'
            style={{}}
        >{children}</span>
    </span>
}
export default LyricPlayer;
